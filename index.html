<doctype HTML>
    <meta charset="utf-8">
    <meta name="viewport" content="width=device-width">

    <head>

        <link
            href="https://fonts.googleapis.com/css?family=Noto+Sans:400,400i,700,700i|Oswald:200,300,400,500,600,700&display=swap&subset=latin-ext"
            rel="stylesheet">
        <link rel="stylesheet" href="css/bootstrap.min.css">
        <link rel="stylesheet" type="text/css" href="css/site.css">
        <script src="https://code.jquery.com/jquery-3.5.0.js"
            integrity="sha256-r/AaFHrszJtwpe+tHyNi/XCfMxYpbsRg2Uqn0x3s2zc=" crossorigin="anonymous"></script>

        <script src="libs/d3.v4.min.js"></script>
        <script src="libs/d3-queue.v3.min.js"></script>
        <link rel="icon" href="img/favicon.ico">

    </head>

    <body>
        <h1>Job retention schemes</h1><br>
        <h2>Share of dependent employees</h2>
        <img id="Share" src="img/share.svg" alt="share">

    <div class="flex-container" id="Downloadbanner">
        <button class="toData active" id="OECDbtn" onclick="drawChart(value)" value="OECD">OECD</button>
        <button class="toData" id="WORLDbtn" onclick="drawChart(value)" value="WORLD">World</button>
    </div>
        <div id="GDPchart"></div>
        <div id="source" class="source">Source: <a class="source" href="https://doi.org/10.1787/1686c758-en" target="_blank">OECD (2020), OECD Employment Outlook
            2020: Worker Security and the COVID-19 Crisis, OECD Publishing, Paris.</a></div><div id="shareLink">
            <div id="shutterholdertracker">
                <img id="shuttershare" src="img/cross.svg">
                <div id="trackersText">
                    <b>Copy link:</b><Br />
                    <span>https://oecd.github.io/EO-Outlook_chart_3/</span><Br />
                    <b>Embed link:</b><Br />
                    <textarea
                        readonly><iframe src="https://oecd.github.io/EO-Outlook_chart_3/" width="100%" height="500px" style="border:none;"></iframe></textarea>
        
                </div>
            </div>
        </div>
    </body>
    <script>
        var dataPerm=[];
        var valueButton="OECD"
        var G7list=["CAN","FRA","DEU","ITA","JPN","GBR","USA","EA17"] 
        var OECDlist=["AUS", "AUT", "BEL", "CAN,", "CHL", "COL", "CZE", "DNK", "EST", "FIN", "FRA", "DEU", "GRC", "HUN", "ISL", "IRL", "ISR", "ITA", "JPN", "KOR", "LVA", "LTU", "LUX", "MEX", "NLD", "NZL", "NOR", "POL", "PRT", "SVK", "SVN", "ESP", "SWE", "CHE", "TUR", "GBR", "USA", "OTO"]
        
        var keys= ["data1", "diff"]

    var divMap = d3.select("body").append("div")
        .attr("class", "tooltip")
        .style("opacity", 0);


    var color = d3.scaleOrdinal()
        .domain(keys)
        .range([ "#00b5cb", "#851017"])

  
    var margin = { top: 10, right: 50, bottom: 80, left: 50 };

    var mapRatio = 7 / 20;

    var width = document.getElementById("GDPchart").offsetWidth - margin.left - margin.right;

    var height;
    if (width > 650)
        height=360//height = width * mapRatio;
    else
        height = 360//height = width;


    var urls = {
        data1: "data/data1.tsv",
        data2: "data/data2.tsv",
    };

    d3.queue()
        .defer(d3.tsv, urls.data1)
        .defer(d3.tsv, urls.data2)
        .await(render);

    var GDPsvg= d3.select("#GDPchart").append("svg")
        .attr("width", width + margin.left + margin.right)
        .attr("height", height + margin.top + margin.bottom)
        .append("g")
        .attr("transform",
            "translate(" + margin.left + "," + margin.top + ")");

    // set x scale
    var x = d3.scaleBand()
        .rangeRound([0, width])
        .paddingInner(0.05)
        .align(0.1);


    // set y scale
    var y = d3.scaleLinear()
        .rangeRound([height-margin.bottom, margin.top]);


    function render(err, Data1, Data2) {
        var count=0
        Data1.forEach(function (d) {
            count++
            Data2.forEach(function (k) {
                if(k.LOCATION==d.LOCATION){
                    

                    var countryName=d.Country;
                    if(d.Country== "China (People's Republic of)")
                        countryName="China"
                    if (d.Country == "OECD - Total")
                        countryName = "OECD"
                    if (d.Country == "Euro area (17 countries)")
                        countryName = "Euro area"
                    dataPerm.push({ "Country": countryName, "ISO": d.LOCATION, "data1":d.Approved_applications, "data2":k.Approved_applications, "Actual_use": d.Actual_use,"headcount":d.Headcounts})
                }
            })
            if(count== Data1.length)
                drawChart(valueButton)
        })
    }


    var btnContainer = document.getElementById("Downloadbanner");
    // Get all buttons with class="btn" inside the container
    var btns = btnContainer.getElementsByClassName("toData");

    // Loop through the buttons and add the active class to the current/clicked button
    for (var i = 0; i < btns.length; i++) {
        btns[i].addEventListener("click", function () {
            var current = document.getElementsByClassName("active");
            current[0].className = current[0].className.replace(" active", "");
            this.className += " active";
        });
    }

    function drawChart(value){
        GDPsvg.selectAll("*").remove();

        valueButton = value;
        var data=[];
        
        if(value=="G7"){
            G7list.forEach(function (d) {
                dataPerm.forEach(function (k) {
                    if (d == k.ISO)
                        data.push(k)
                })

            })
        }else if (value == "OECD") {
            OECDlist.forEach(function (d) {
                dataPerm.forEach(function (k) {
                    if (d == k.ISO)
                        data.push(k)
                })

            })
        }else{
            data=dataPerm
        }
            


         width = document.getElementById("GDPchart").offsetWidth - margin.left - margin.right;

        if (width > 650)
            height = 360//height = width * mapRatio;
        else
            height = 360//height = width;

        
        d3.selectAll("svg")
            .attr("width", width + margin.left + margin.right)

            GDPsvg.append("g")
            .attr("transform",
                "translate(" + margin.left + "," + margin.top + ")");

        // set x scale
        x.rangeRound([0, width])

        if (width >650 && valueButton != "G7")
            x.paddingInner(0.05)
        else if(width > 650 && valueButton == "G7")
            x.paddingInner(0.5)
        else if (width < 650)
            x.paddingInner(0.5)


        data.sort(function (a, b) { return b.data1 - a.data1; });

        x.domain(data.map(function (d) { return d.Country; }));

        y.domain([ 0, d3.max(data, function (d) { return parseFloat(d.data1); })]).nice();
       


        GDPsvg.append("g")
            .attr("class", "axis")
            .attr("transform", "translate(0," + height + ")")
            .call(d3.axisBottom(x))
            .selectAll("text")
            .style("text-anchor", "end")
            .attr("dx", "4em")
            .attr("dy", "-0.5em")
            .attr("transform", "rotate(-90)");  


        GDPsvg.append("g")
            .attr("class", "axis")
            //.call(d3.axisLeft(y).ticks(null, "s"))
            .call(d3.axisLeft(y).ticks(5).tickFormat(function (d) {
                return y.tickFormat(20, d3.format(".0f"))(d) + "%"
            }).tickSize(-(width)));
            
        GDPsvg.append("g")
            .selectAll("g")
            .data(d3.stack().keys(keys)(data))
            .enter().append("g")
            .attr("fill", function (d) { return color(d.key); })
            .selectAll("rect")
            .data(function (d) { return d; })
            .enter().append("rect")
            .attr("opacity", function (d) {
                if (d.data.ISO == "EA17" || d.data.ISO == "OTO" || d.data.ISO == "WLD"  || d.data.ISO == "G20")
                    return 0.6;
                else
                    return 1;
            })
            .attr("x", function (d) { return x(d.data.Country); })
            .attr("y", function (d) {  return y(parseFloat(d[1])); })//y(d[1] for positive values
            .attr("height", function (d) { return (parseFloat(y(d[0])) - parseFloat(y(d[1]))); }) //remove - in front  for positive values
            .attr("width", x.bandwidth())
            .on("mouseover", function () { 
                d3.select(this).attr("opacity",0.2)
            })
            .on("mouseout", function (d) { 
                
                d3.select(this)
                .attr("opacity",function () {
                    if (d.data.ISO == "EA17" || d.data.ISO == "OTO" || d.data.ISO == "WLD" || d.data.ISO == "G20")
                        return 0.6;
                    else
                        return 1;
                })

                divMap.transition()
                    .duration(100)
                    .style("opacity", 0);
                 })
            .on("mousemove", function (d) {

                divMap.transition()
                    .duration(100)
                    .style("opacity", 1);

                var htmlText =  "<b>" + d.data.Country + "</b><br/>&nbsp;Approved applications: <b>" + d.data.data1  + "%</b> <br>&nbsp;Actual use :<b>" + d.data.Actual_use + "%</b>  <br>&nbsp;Head counts :<b>" + d.data.headcount ;

                if (event.pageX < width - 75) {
                    divMap.html(htmlText)
                        .style("left", event.pageX + "px")
                        .style("top", event.pageY + "px");
                } else {
                    divMap.html(htmlText)
                        .style("left", width - 100 + "px")
                        .style("top", event.pageY + "px");
                }
                
            });

    }

        d3.select("#Share").on("click", function () {
            document.getElementById("shareLink").style.display = "inline-block";
        })
        d3.select("#shuttershare")
            .on("mouseover", function () {
                d3.select(this).style("opacity", 0.5);
            })
            .on("mouseout", function () {
                d3.select(this).style("opacity", 1);
            })
            .on("click", function () {
                document.getElementById("shareLink").style.display = 'none';
            })
    
    
    $(window).on('resize', function(){drawChart(valueButton);});
    </script>